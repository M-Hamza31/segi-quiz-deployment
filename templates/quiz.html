<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Survey For Pakistani Students</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* Background / container */
        body {
            background: linear-gradient(135deg, #005f73, #0a9396);
            min-height: 100vh;
            color: #333;
            font-family: 'Poppins', sans-serif;
        }
        .container {
            max-width: 780px;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 40px 30px;
            margin-top: 50px;
            backdrop-filter: blur(6px);
            animation: fadeIn 0.8s ease-in-out;
        }

        /* Title & logo */
        .title {
            font-weight: 800;
            color: #005f73;
        }
        img.logo {
            max-height: 90px;
            margin-bottom: 15px;
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.15));
            animation: float 3s ease-in-out infinite;
        }

        /* Question card */
        .question-card {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .q-header {
            color: #0a9396;
            font-weight: 600;
        }

        /* Prominent radio buttons */
        .form-check-input {
            width: 1.3em;
            height: 1.3em;
            border: 2px solid #0a9396;
            cursor: pointer;
            box-shadow: none;
        }
        .form-check-input:checked {
            background-color: #005f73;
            border-color: #005f73;
        }
        .form-check-label {
            margin-left: .5rem;
            font-weight: 500;
        }

        /* Inputs */
        .form-control {
            border-radius: 10px;
            border: 1px solid #ddd;
            padding: 12px;
            font-size: 1rem;
        }
        .form-control:focus {
            border-color: #005f73;
            box-shadow: 0 0 6px rgba(0,95,115,0.18);
        }

        /* Buttons */
        .submit-btn {
            background: linear-gradient(90deg, #0a9396, #005f73);
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.15em;
            border: none;
        }
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1em;
            border: none;
            margin-top: 15px;
            text-decoration: none;
            display: block;
            text-align: center;
        }

        /* Alerts area spacing */
        #alertPlaceholder { margin-bottom: 15px; }

        /* Privacy Note Styling */
        /* Re-added as plain text without box, preserving color/weight for contrast if possible */
        .privacy-text {
            text-align: center;
            font-size: 1.05em;
            color: #555; /* Darker text for readability */
            margin-top: 25px;
            margin-bottom: 25px;
        }
        .privacy-text strong {
            font-weight: 600;
            color: #333;
        }


        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* Small helper for invalid messages (used by JS) */
        .invalid-note { color: #b02a37; font-weight: 600; margin-top: 8px; display: none; }
    </style>

    <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
<div class="container">
    <div id="alertPlaceholder"></div>

    <div class="text-center mb-4">
        <img src="{{ url_for('static', filename='segi logo.png') }}" class="logo" alt="SEGi Logo">
        <h1 class="title">Survey For Pakistani Students</h1>
        <p class="lead text-muted">Help us understand your study goals and match you with the right SEGi program.</p>
    </div>

    <form id="quizForm" method="POST" novalidate>
        {{ form.hidden_tag() }}

        <h4>Step 1: Your Profile</h4>

        {% for field in [form.qualification, form.discipline, form.malaysia_intent,
                         form.segi_interest, form.motivation, form.study_environment, form.career_goal] %}
            <div class="question-card" data-field-name="{{ field.name }}">
                <p class="q-header">{{ field.label }}</p>
                {% for subfield in field %}
                <div class="form-check">
                    {{ subfield(class="form-check-input") }}
                    <label class="form-check-label">{{ subfield.label }}</label>
                </div>
                {% endfor %}
                <div class="invalid-note">Please select an option for this question.</div>
            </div>
        {% endfor %}

        <h4>Step 2: Your Contact Details ðŸ“±</h4>

        <div class="mb-3">
            <label class="form-label">{{ form.student_name.label }}</label>
            {{ form.student_name(class="form-control", placeholder="Your Full Name", id="student_name") }}
            <div class="invalid-note" id="nameNote">Please enter your name.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">{{ form.student_email.label }}</label>
            {{ form.student_email(class="form-control", placeholder="name@example.com", id="student_email") }}
            <div class="invalid-note" id="emailNote">Please enter a valid email.</div>
        </div>

        <div class="mb-4">
            <label class="form-label">{{ form.student_phone.label }}</label>
            {{ form.student_phone(class="form-control", placeholder="+60 XXX XXXX XXXX", id="student_phone") }}
            <div class="invalid-note" id="phoneNote">Please enter your phone number.</div>
        </div>

        {{ form.submit(class="btn submit-btn w-100", id="submitBtn") }}
    </form>
    
    <div class="privacy-text">
        Your info stays private & will only be used by SEGi advisors <i class="far fa-comment-dots"></i>
    </div>
    <button id="whatsappBtn" class="whatsapp-btn w-100" type="button">
        <i class="fab fa-whatsapp"></i> Chat with SEGi Representative in Pakistan
    </button>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Utility: show Bootstrap alert in the alertPlaceholder
    function showAlert(message, type = 'danger', timeout = 5000) {
        const placeholder = document.getElementById('alertPlaceholder');
        placeholder.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        if (timeout) {
            setTimeout(() => {
                const alertEl = placeholder.querySelector('.alert');
                if (alertEl) {
                    const bsAlert = bootstrap.Alert.getOrCreateInstance(alertEl);
                    bsAlert.close();
                }
            }, timeout);
        }
    }

    // Basic email regex for client-side check (not bulletproof)
    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Validate form: required contact fields + each radio question must have a selection
    function validateForm() {
        let valid = true;
        // Clear previous invalid notes
        document.querySelectorAll('.invalid-note').forEach(n => n.style.display = 'none');

        // Name
        const name = document.getElementById('student_name');
        if (!name || !name.value.trim()) {
            document.getElementById('nameNote').style.display = 'block';
            valid = false;
        }

        // Email
        const email = document.getElementById('student_email');
        if (!email || !email.value.trim() || !isValidEmail(email.value.trim())) {
            document.getElementById('emailNote').style.display = 'block';
            valid = false;
        }

        // Phone (basic non-empty check)
        const phone = document.getElementById('student_phone');
        if (!phone || !phone.value.trim()) {
            document.getElementById('phoneNote').style.display = 'block';
            valid = false;
        }

        // Radio groups: iterate question-card blocks with data-field-name
        const questionCards = document.querySelectorAll('.question-card[data-field-name]');
        const missing = [];
        questionCards.forEach(card => {
            const fieldName = card.getAttribute('data-field-name');
            // look for checked input with that name
            const checked = card.querySelector(`input[name="${fieldName}"]:checked`);
            if (!checked) {
                // show inline invalid note
                const note = card.querySelector('.invalid-note');
                if (note) note.style.display = 'block';
                valid = false;
                missing.push(fieldName);
            }
        });

        if (!valid) {
            // Build a friendly message
            let message = 'Please fix the highlighted fields before continuing.';
            if (missing.length) {
                message = 'Make sure all questions are answered and contact details are filled.';
            }
            showAlert(message, 'danger', 6000);
        }

        return valid;
    }

    const quizForm = document.getElementById('quizForm');
    
    // 1. Normal form submit (triggered by 'submitBtn') will use the default server action
    quizForm.addEventListener('submit', function (e) {
        if (!validateForm()) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        } else {
            // allow natural submit to proceed to server/redirect
            showAlert('Submitting your info â€” please wait...', 'success', 2500);
            return true;
        }
    });

    // 2. WhatsApp button: validate â†’ submit ASYNCHRONOUSLY â†’ open whatsapp link
    document.getElementById('whatsappBtn').addEventListener('click', function (e) {
        // Run validation first
        if (!validateForm()) {
            e.preventDefault(); // Stop any form-related action if validation fails
            return; // don't submit or open whatsapp
        }

        // Get the form data
        const formData = new FormData(quizForm);

        // Submit the form data asynchronously (in the background) using fetch
        fetch(quizForm.action || window.location.href, {
            method: quizForm.method || 'POST', // Use the form's method (usually POST)
            body: formData,
        })
        .then(response => {
            // Optional: Handle server response if needed (e.g., check for success/error codes)
            if (response.ok) {
                 console.log('Form data submitted successfully in the background.');
            } else {
                 console.error('Server returned an error, but proceeding to WhatsApp.');
            }
        })
        .catch(error => {
            // Handle network errors
            console.error('Network error during form submission:', error);
            showAlert('Error submitting data, but opening WhatsApp now.', 'warning', 5000);
        });

        // Immediately open WhatsApp in a new tab (this doesn't wait for the fetch to complete)
        window.open(
            "https://wa.me/923361812598?text=Hello%20SEGi%20Pakistan%20Advisor%2C%20I%20just%20filled%20the%20survey%20and%20need%20program%20guidance.",
            "_blank"
        );
        
        // Prevent any default form action (since we're handling submission via fetch)
        e.preventDefault(); 
    });

    // Optional: Remove alert on input change for better UX
    document.querySelectorAll('#quizForm input').forEach(inp => {
        inp.addEventListener('input', () => {
            // hide alert placeholder if any
            const ph = document.getElementById('alertPlaceholder');
            if (ph) ph.innerHTML = '';
            // hide inline note for this input's question-card if radio selected
            if (inp.type === 'radio' && inp.checked) {
                const card = inp.closest('.question-card');
                if (card) {
                    const note = card.querySelector('.invalid-note');
                    if (note) note.style.display = 'none';
                }
            }
            // hide contact notes as user types
            if (inp.id === 'student_name') document.getElementById('nameNote').style.display = 'none';
            if (inp.id === 'student_email') document.getElementById('emailNote').style.display = 'none';
            if (inp.id === 'student_phone') document.getElementById('phoneNote').style.display = 'none';
        });
    });
</script>

</body>
</html>